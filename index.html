<!DOCTYPE html>
<html lang="th">
<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDPA | ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; margin: 30px; background-color: #f5f5f5; }
        .container { max-width: 500px; margin: auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
        .hidden { display: none !important; }
        img { width: 100px; height: 100px; object-fit: cover; border-radius: 50%; display: block; margin: 0 auto 10px; border: 2px solid #ccc; }
        h2, h3, h4 { text-align: center; color: #2c3e50; }
        .pdpa-box { max-height: 300px; overflow-y: auto; border: 1px solid #ccc; padding: 15px; border-radius: 8px; background-color: #E8F0FE; margin-bottom: 15px; }
        
        /* Loading Overlay Styles (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) */
        #loadingOverlay { display: flex; justify-content: center; align-items: center; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.8); z-index: 10000; }
        .lds-ring { display: inline-block; position: relative; width: 80px; height: 80px; }
        .lds-ring div { box-sizing: border-box; display: block; position: absolute; width: 64px; height: 64px; margin: 8px; border: 8px solid #2d87f0; border-radius: 50%; animation: lds-ring 1.2s cubic-bezier(0.5, 0, 0.5, 1) infinite; border-color: #2d87f0 transparent transparent transparent; }
        @keyframes lds-ring { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loading-text { margin-top: 20px; font-size: 1.2rem; color: #333; }
        .consent-area { margin-top: 10px; }
    </style>
</head>
<body>
    <div id="loadingOverlay">
        <div style="text-align:center;">
            <div class="lds-ring"><div></div><div></div><div></div><div></div></div>
            <p class="loading-text" id="loadingText">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LIFF...</p>
        </div>
    </div>

    <div class="container hidden" id="mainContent">
        <h2>üõ†Ô∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ PDPA</h2>
        <img id="profileImage">
        
        <p class="text-center" style="font-size: 0.9rem; color: #777; margin-bottom: 20px;">
            **Line User ID:** <span id="userIdDisplay" style="color: #333; font-weight: bold; word-break: break-all;">[‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...]</span>
        </p>
        <input type="hidden" id="userId" readonly>
        <input type="hidden" id="displayName" readonly>
        <input type="hidden" id="logRowIndex"> <p id="alertMessage" class="alert alert-danger text-center hidden"></p>

        <hr>
        
        <div id="statusSummary" class="hidden text-center p-3 border rounded" style="background-color: #fff3cd;">
            <h4>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ PDPA ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</h4>
            <p><strong>ID13 ‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô:</strong> <span id="summaryIdCard" style="color: green; font-weight: bold;">-</span></p>
            <p><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°:</strong> <span id="summaryStatus" style="font-size: 1.2rem; font-weight: bold;">-</span></p>
            
            <button type="button" class="btn btn-warning btn-lg mt-3 w-100" onclick="showUpdateSection()" id="editButton">
                ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç/‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
            </button>
        </div>
        <div id="pdpaUpdateSection" class="hidden">
            <h4 class="text-center" style="text-decoration: underline;">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</h4>
            <p><strong>‡∏¢‡∏®-‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•:</strong> <span id="fullUserName" style="color: blue;">-</span></p>
            <p><strong>‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô:</strong> <span id="idCardDisplay" style="color: #777;">-</span></p>
            
            <hr>
            
            <h3>‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• (PDPA)</h3>
            <div class="pdpa-box" id="pdpaContent"></div>

            <h4 style="margin-top: 20px;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏´‡∏°‡πà (‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï)</h4>
            <div class="consent-area text-center" id="consentSection">
                <input type="radio" id="consentCheckbox_1" name="pdpa_consent_new" value="1" style="vertical-align: middle; margin-right: 5px;">
                <label for="consentCheckbox_1" style="display: inline;">‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°</label>
                
                <input type="radio" id="consentCheckbox_0" name="pdpa_consent_new" value="0" style="vertical-align: middle; margin-right: 5px; margin-left: 20px;">
                <label for="consentCheckbox_0" style="display: inline;">‡πÑ‡∏°‡πà‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°</label>
            </div>
            
            <br>
            <button type="button" class="btn btn-danger btn-lg w-100" onclick="updateConsent()" id="updateBtn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
            <p id="consentMessage" style="margin-top: 10px; color: red;"></p>
        </div>
        
        <button type="button" class="btn btn-info btn-lg w-100 mt-3" id="closeBtn" onclick="closeLiff()">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</button>
    </div>
    
    <script src="https://static.line-scdn.net/liff/edge/versions/2.9.0/sdk.js"></script>
    <script>
        // üö® **‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô URL ‡πÅ‡∏•‡∏∞ LIFF ID ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà**
        const GAS_URL = "https://script.google.com/macros/s/AKfycbztxMsVpuUKuDdHM9JoOb2GxvO4A6ZzTrYhLeFvWrB-HiIZtWo7dISYH2MhaPRGZzF0/exec";
        const LIFF_ID = "2007674245-8mRaxkdj"; 

        function showLoading(message = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...") {
            document.getElementById("loadingText").textContent = message;
            document.getElementById("loadingOverlay").style.display = "flex";
        }
        function hideLoading() {
            document.getElementById("loadingOverlay").style.display = "none";
        }
        function setAlert(message, type = 'danger') {
            const el = document.getElementById("alertMessage");
            el.textContent = message;
            el.className = `alert alert-${type} text-center`;
            el.classList.remove('hidden');
        }

        // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡∏∞‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° UI
        function runApp() {
            showLoading("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞..."); 
            
            liff.getProfile().then(profile => {
                document.getElementById("profileImage").src = profile.pictureUrl;
                
                const userId = profile.userId;
                document.getElementById("userId").value = userId; 
                document.getElementById("userIdDisplay").textContent = userId; // ‡πÅ‡∏™‡∏î‡∏á Line User ID

                document.getElementById("displayName").value = profile.displayName;
                document.getElementById("mainContent").classList.remove("hidden");

                fetch(GAS_URL, {
                    method: 'POST',
                    body: new URLSearchParams({
                        action: 'checkExistingUser', // GAS Function ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á
                        userId: userId
                    })
                })
                .then(res => res.json())
                .then(data => {
                    hideLoading();
                    
                    if (data.status === 'exists_ready_to_update') {
                        // 1. ‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ - ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏•‡∏∞‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                        const statusText = data.currentConsent === '1' ? '‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°' : '‡πÑ‡∏°‡πà‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°';
                        setAlert(`‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏Ñ‡∏∑‡∏≠ ${statusText}`, 'info');
                        
                        document.getElementById("statusSummary").classList.remove("hidden");
                        document.getElementById("summaryIdCard").textContent = data.idCard;
                        document.getElementById("summaryStatus").textContent = statusText;
                        
                        // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡πÑ‡∏ß‡πâ‡πÉ‡∏ô data attribute ‡∏Ç‡∏≠‡∏á element ‡∏ó‡∏µ‡πà‡∏ã‡πà‡∏≠‡∏ô‡∏≠‡∏¢‡∏π‡πà
                        document.getElementById("logRowIndex").value = data.rowIndex; 
                        document.getElementById("userId").dataset.idcard = data.idCard;
                        document.getElementById("userId").dataset.fullname = data.fullUserName;
                        document.getElementById("userId").dataset.pdpaContent = data.pdpaContent;
                        document.getElementById("userId").dataset.currentConsent = data.currentConsent;

                    } else if (data.status === 'notExists') {
                        // 2. ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ - ‡πÅ‡∏à‡πâ‡∏á‡πÉ‡∏´‡πâ‡πÑ‡∏õ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô
                        setAlert(data.message + " ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô PDPA", 'danger');
                        document.getElementById("statusSummary").classList.add("hidden");

                    } else {
                        // 3. ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏≠‡∏∑‡πà‡∏ô‡πÜ
                        setAlert(data.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'danger');
                        document.getElementById("statusSummary").classList.add("hidden");
                    }
                })
                .catch(err => {
                    hideLoading();
                    setAlert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: " + err.message, 'danger');
                    console.error('Fetch error:', err);
                });
                
            }).catch(err => {
                hideLoading();
                setAlert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå LINE: " + err.message, 'danger');
            });
        }

        // 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç/‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï"
        function showUpdateSection() {
            const idCard = document.getElementById("userId").dataset.idcard;
            const fullUserName = document.getElementById("userId").dataset.fullname;
            const pdpaContent = document.getElementById("userId").dataset.pdpaContent;
            const currentConsent = document.getElementById("userId").dataset.currentConsent;

            // ‡∏ã‡πà‡∏≠‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏•‡∏∞‡∏õ‡∏∏‡πà‡∏°
            document.getElementById("statusSummary").classList.add("hidden");

            // ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (pdpaUpdateSection)
            document.getElementById("pdpaUpdateSection").classList.remove("hidden");
            document.getElementById("fullUserName").textContent = fullUserName || '-';
            document.getElementById("idCardDisplay").textContent = idCard; 
            document.getElementById("pdpaContent").innerHTML = pdpaContent;
            
            // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Radio Buttons ‡πÅ‡∏•‡∏∞ Logic ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
            const radio1 = document.getElementById("consentCheckbox_1");
            const radio0 = document.getElementById("consentCheckbox_0");
            
            // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÅ‡∏•‡∏∞ Logic ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
            if (currentConsent === '1') {
                radio1.checked = true; // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°
                radio0.disabled = false;
                setAlert("‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏Ñ‡∏∑‡∏≠ '‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°' ‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å '‡πÑ‡∏°‡πà‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°'", 'warning');
            } else if (currentConsent === '0') {
                radio0.checked = true; // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°
                radio0.disabled = true; // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å '‡πÑ‡∏°‡πà‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°' ‡∏ã‡πâ‡∏≥‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ
                radio1.disabled = false;
                setAlert("‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏Ñ‡∏∑‡∏≠ '‡πÑ‡∏°‡πà‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°' **‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å '‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°'** ‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞", 'danger');
            }
        }

        // 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ GAS)
        function updateConsent() {
            const selectedConsent = document.querySelector('input[name="pdpa_consent_new"]:checked');
            const idCard = document.getElementById("userId").dataset.idcard;
            const logRowIndex = document.getElementById("logRowIndex").value;
            const currentConsent = document.getElementById("userId").dataset.currentConsent; // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏î‡∏¥‡∏°

            if (!selectedConsent) {
                alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏´‡∏°‡πà");
                return;
            }
            
            const newConsentStatus = selectedConsent.value;

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ã‡πâ‡∏≥
            if (currentConsent === '0' && newConsentStatus === '0') {
                alert("‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏Ñ‡∏¢‡πÄ‡∏•‡∏∑‡∏≠‡∏Å '‡πÑ‡∏°‡πà‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°' ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å '‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°' ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô");
                return;
            }
            if (currentConsent === newConsentStatus) {
                alert("‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏î‡∏¥‡∏°‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß");
                return;
            }


            showLoading("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏¢‡πâ‡∏≤‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...");
            
            fetch(GAS_URL, {
                method: "POST",
                body: new URLSearchParams({
                    action: "updateAndMigrateConsent", // GAS Function ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á
                    idCard: idCard,
                    newConsentStatus: newConsentStatus,
                    logRowIndex: logRowIndex 
                })
            })
            .then(res => res.json())
            .then(data => {
                hideLoading();
                if (data.status === "success") {
                    alert(data.message); // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å H1 ‡πÉ‡∏ô GAS
                    setAlert(data.message, 'success');
                    document.getElementById("updateBtn").classList.add("hidden");
                    document.getElementById("consentSection").classList.add("hidden");
                } else {
                    alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + data.message);
                    setAlert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + data.message, 'danger');
                }
            })
            .catch(err => {
                hideLoading();
                alert("‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: " + err.message);
                console.error(err);
                setAlert("‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: " + err.message, 'danger');
            });
        }

        function closeLiff() {
            liff.closeWindow();
        }

        // LIFF initialization
        liff.init({ liffId: "2008429931-5gKEregX" }, () => {
            if (liff.isLoggedIn()) {
                runApp();
            } else {
                liff.login();
            }
        }, err => {
            hideLoading();
            setAlert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô LIFF: " + err.message, 'danger');
            console.error('LIFF init error:', err);
        });
    </script>
</body>
</html>
